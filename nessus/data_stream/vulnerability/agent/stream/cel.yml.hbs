config_version: 2
interval: {{interval}}
resource.url: {{url}}
resource.ssl.verification_mode: {{ssl_verification_mode}}
{{#if ssl_certificate_authorities}}
resource.ssl.certificate_authorities:
{{#each ssl_certificate_authorities}}
  - {{this}}
{{/each}}
{{/if}}
{{#if proxy_url}}
resource.proxy_url: {{proxy_url}}
{{/if}}
resource.timeout: 300s
resource.headers:
  X-ApiKeys: "accessKey={{access_key}}; secretKey={{secret_key}}"
{{#if enable_request_tracer}}
resource.tracer.filename: "../../logs/cel/http-request-trace-*.ndjson"
resource.tracer.maxbackups: 5
{{/if}}
state:
  want_more: false
  last_seen_time: 0
tags:
{{#each tags as |tag|}}
  - {{tag}}
{{/each}}
program: |
  request("GET", state.url + "/scans").do_request().as(scans_resp,
    scans_resp.StatusCode == 200 ?
      bytes(scans_resp.Body).decode_json().as(body,
        (has(body.scans) && body.scans != null ? body.scans : [])
          .filter(s, s.status == "completed" || s.status == "imported")
          .filter(s, has(s.last_modification_date) && s.last_modification_date > int(state.last_seen_time))
          .as(new_scans,
            new_scans.size() > 0 ?
              new_scans.map(scan,
                string(scan.id).as(scan_id_str,
                  request("GET", state.url + "/scans/" + scan_id_str).do_request().as(scan_resp,
                    scan_resp.StatusCode == 200 ?
                      bytes(scan_resp.Body).decode_json().as(scan_body,
                        (has(scan_body.hosts) && scan_body.hosts != null ? scan_body.hosts : []).map(host,
                          request("GET", state.url + "/scans/" + scan_id_str + "/hosts/" + string(host.host_id)).do_request().as(host_resp,
                            host_resp.StatusCode == 200 ?
                              bytes(host_resp.Body).decode_json().as(host_body,
                                (has(host_body.vulnerabilities) && host_body.vulnerabilities != null ? host_body.vulnerabilities : [])
                                  .filter(v, v.severity >= {{min_severity}})
                                  .map(vuln,
                                    request("GET", state.url + "/scans/" + scan_id_str + "/hosts/" + string(host.host_id) + "/plugins/" + string(vuln.plugin_id)).do_request().as(plugin_resp,
                                      (plugin_resp.StatusCode == 200 ? bytes(plugin_resp.Body).decode_json() : {}).as(pd,
                                        (has(pd.info) && has(pd.info.plugindescription) && has(pd.info.plugindescription.pluginattributes) ? pd.info.plugindescription.pluginattributes : {}).as(pa,
                                          (has(pa.risk_information) ? pa.risk_information : {}).as(ri,
                                            (has(pa.ref_information) && has(pa.ref_information.ref) ? pa.ref_information.ref : []).as(refs,
                                              (has(pa.plugin_information) ? pa.plugin_information : {}).as(pi,
                                                {
                                                  "message": {
                                                    "nessus": {
                                                      "scan_id": scan.id,
                                                      "scan_name": has(scan_body.info) && has(scan_body.info.name) ? scan_body.info.name : "",
                                                      "scan_uuid": has(scan_body.info) && has(scan_body.info.uuid) ? scan_body.info.uuid : "",
                                                      "scan_start": has(scan_body.info) && has(scan_body.info.scanner_start) ? scan_body.info.scanner_start : null,
                                                      "scan_end": has(scan_body.info) && has(scan_body.info.scanner_end) ? scan_body.info.scanner_end : null,
                                                      "host_id": host.host_id,
                                                      "hostname": has(host.hostname) ? host.hostname : "",
                                                      "host_ip": has(host_body.info) && "host-ip" in host_body.info ? string(host_body.info["host-ip"]) : (has(host.hostname) ? host.hostname : ""),
                                                      "host_fqdn": has(host_body.info) && "host-fqdn" in host_body.info ? string(host_body.info["host-fqdn"]) : "",
                                                      "host_os": has(host_body.info) && "operating-system" in host_body.info ? string(host_body.info["operating-system"]) : "",
                                                      "plugin_id": vuln.plugin_id,
                                                      "plugin_name": has(vuln.plugin_name) ? vuln.plugin_name : "",
                                                      "plugin_family": has(vuln.plugin_family) ? vuln.plugin_family : "",
                                                      "severity": vuln.severity,
                                                      "count": has(vuln.count) ? vuln.count : 1,
                                                      "synopsis": has(pa.synopsis) ? pa.synopsis : "",
                                                      "description": has(pa.description) ? pa.description : "",
                                                      "solution": has(pa.solution) ? pa.solution : "",
                                                      "see_also": has(pa.see_also) ? pa.see_also : [],
                                                      "cvss_base_score": has(ri.cvss_base_score) ? ri.cvss_base_score : "",
                                                      "cvss3_base_score": has(ri.cvss3_base_score) ? ri.cvss3_base_score : "",
                                                      "cvss3_vector": has(ri.cvss3_vector) ? ri.cvss3_vector : "",
                                                      "cvss_vector": has(ri.cvss_vector) ? ri.cvss_vector : "",
                                                      "risk_factor": has(ri.risk_factor) ? ri.risk_factor : "",
                                                      "cve": refs.filter(r, has(r.name) && r.name == "cve").map(r, has(r.values) && has(r.values.value) ? r.values.value : []).flatten(),
                                                      "cwe": refs.filter(r, has(r.name) && r.name == "cwe").map(r, has(r.values) && has(r.values.value) ? r.values.value : []).flatten(),
                                                      "plugin_pub_date": has(pi.plugin_publication_date) ? pi.plugin_publication_date : "",
                                                      "plugin_mod_date": has(pi.plugin_modification_date) ? pi.plugin_modification_date : "",
                                                      "plugin_output": has(pd.outputs) && pd.outputs.size() > 0 && has(pd.outputs[0].plugin_output) ? pd.outputs[0].plugin_output : ""
                                                    }
                                                  }.encode_json()
                                                }
                                              )
                                            )
                                          )
                                        )
                                      )
                                    )
                                  )
                              )
                            :
                              []
                          )
                        ).flatten()
                      )
                    :
                      []
                  )
                )
              ).flatten().as(all_events,
                {
                  "events": all_events,
                  "last_seen_time": new_scans.map(s, s.last_modification_date).max(),
                  "want_more": false
                }
              )
            :
              {"events": [], "last_seen_time": state.last_seen_time, "want_more": false}
          )
      )
    :
      {"events": [], "last_seen_time": state.last_seen_time, "want_more": false}
  )
